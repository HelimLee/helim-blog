<!DOCTYPE html>
<html lang="zh-cn"><head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

   <meta name="description" content="Umami官方给的自托管部署模式实在是坑太多了。简直是一种折磨。本文是对官方文档的补充。
官方文档：https://umami.is/docs/install
环境准备 一台干净安装的Ubuntu或类似发行版（本次安装只在Ubuntu上测试）：“干净的”并非一定代表全新安装。一些文明的、不会把你的系统搞得一团糟的程序是可以安装的。但如果你的系统上已经存在了2个及以上的Web Server或数据库，那么你的确应该考虑调整系统策略。
安装Postgresql 这里就来了第一个坑：虽然官方文档里写着“mysql或postgresql”，但经过我的实际操作，发现其实只有postgresql才能完成最后的配置。所以不要尝试安装mysql，而是直接安装postgresql.且安装postgresql要更加简单。可以直接从ubuntu默认仓库中二进制安装。
apt install postgresql 然后开始创建数据库
sudo -u postgres psql--通过\password为超级用户创建密码\password postgres--创建数据库，请将dbname替换为数据库名称CREATE DATABASE dbname; 接下来是第二个坑。安装完postgresql，并创建数据库后，你可能会看到一些教程指导要求创造一个新的postgresql帐号。这种形式可能会很安全，但并不十分推荐。所以我选择直接允许postgresql的超级用户postgres通过md5密码认证链接。要实现这一点，请导航到postgresql的链路配置文件，通常在/etc/postgresql/&lt;version&gt;/main/pg_hba.conf，其中&lt;version&gt;是版本号。找到这一行：
local	all	postgres	peer#修改为local	all	postgres	md5 现在，如果通过本地链路提起的超级用户登陆请求将通过密码（md5）方式验证。由于来源被限定为本地用户，所以可以称为是安全的。
安装Node.js并更新 这块是第三个大坑。很多人，包括我，在安装之前因为没有apt update或者别的原因，安装了旧版的node.js，导致接下来的yarn安装出现了很多问题。所以要防患于未然，请遵循这些步骤：
#更新apt源 apt update #安装npm，顺道会自动安装nodejs apt install npm #开始更新nodejs npm install -g n n lts #使用n latest更新到最新版本而非lts版本 完成这些步骤后，请安装yarn
npm install -g yarn 安装Umami 安装umami是一个简单的过程。但不当的配置可能使其变得非常复杂。请确保接下来执行的所有命令都在干净的目录中。
#安装umami并使用yarn安装 git clone https://github.com/umami-software/umami.git cd umami yarn install 接下来需要对umami的环境进行一些配置。使用vim .env打开环境变量文件，开始配置
DATABASE_URL=(connection url) 这里的connection url代表的是postgresql的连接地址。它应该是：postgresql://postgresql:你设置的密码@127.">  
  <title>
    
      部署隐私友好的开源网站统计——Umami
    
  </title>


  
  
  
  <link rel="stylesheet" href="/css/main.9fbf43ae1844e7e6ce205daa225f13396ea96162c95b8bd53ece1c6af2ef3e8cfb5f30f3ddb8b3386a5280d089443efb175bd3121e492f0c5c3fd8ea8a4e11d0.css"/>
  
  
</head>
<body a="auto">
        <main class="page-content" aria-label="Content">
            <div class="w">
<a href="/">..</a>

<article>
    <p class="post-meta">
        <time datetime="2023-04-02 16:04:18 &#43;0000 UTC">
            2023-04-02
        </time>
    </p>

    <h1>部署隐私友好的开源网站统计——Umami</h1>

    

    <p>Umami官方给的自托管部署模式实在是坑太多了。简直是一种折磨。本文是对官方文档的补充。</p>
<p>官方文档：https://umami.is/docs/install</p>
<h2 id="环境准备">环境准备</h2>
<p>一台干净安装的Ubuntu或类似发行版（本次安装只在Ubuntu上测试）：“干净的”并非一定代表全新安装。一些文明的、不会把你的系统搞得一团糟的程序是可以安装的。但如果你的系统上已经存在了2个及以上的Web Server或数据库，那么你的确应该考虑调整系统策略。</p>
<h3 id="安装postgresql">安装Postgresql</h3>
<p>这里就来了第一个坑：虽然官方文档里写着“mysql<strong>或</strong>postgresql”，但经过我的实际操作，发现其实<strong>只有</strong>postgresql才能完成最后的配置。所以不要尝试安装mysql，而是直接安装postgresql.且安装postgresql要更加简单。可以直接从ubuntu默认仓库中二进制安装。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>apt install postgresql
</span></span></code></pre></div><p>然后开始创建数据库</p>
<pre tabindex="0"><code class="language-pgsql" data-lang="pgsql">sudo -u postgres psql
--通过\password为超级用户创建密码
\password postgres
--创建数据库，请将dbname替换为数据库名称
CREATE DATABASE dbname;
</code></pre><p>接下来是第二个坑。安装完postgresql，并创建数据库后，你可能会看到一些教程指导要求创造一个新的postgresql帐号。这种形式可能会很安全，但并不十分推荐。所以我选择直接允许postgresql的超级用户postgres通过md5密码认证链接。要实现这一点，请导航到postgresql的链路配置文件，通常在<code>/etc/postgresql/&lt;version&gt;/main/pg_hba.conf</code>，其中&lt;version&gt;是版本号。找到这一行：</p>
<pre tabindex="0"><code class="language-conf" data-lang="conf">local	all	postgres	peer
#修改为
local	all	postgres	md5
</code></pre><p>现在，如果通过本地链路提起的超级用户登陆请求将通过密码（md5）方式验证。由于来源被限定为本地用户，所以可以称为是安全的。</p>
<h3 id="安装nodejs并更新">安装Node.js并更新</h3>
<p>这块是第三个大坑。很多人，包括我，在安装之前因为没有apt update或者别的原因，安装了旧版的node.js，导致接下来的yarn安装出现了很多问题。所以要防患于未然，请遵循这些步骤：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">#更新apt源</span>
</span></span><span style="display:flex;"><span>apt update
</span></span><span style="display:flex;"><span><span style="color:#75715e">#安装npm，顺道会自动安装nodejs</span>
</span></span><span style="display:flex;"><span>apt install npm
</span></span><span style="display:flex;"><span><span style="color:#75715e">#开始更新nodejs</span>
</span></span><span style="display:flex;"><span>npm install -g n
</span></span><span style="display:flex;"><span>n lts <span style="color:#75715e">#使用n latest更新到最新版本而非lts版本</span>
</span></span></code></pre></div><p>完成这些步骤后，请安装yarn</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>npm install -g yarn
</span></span></code></pre></div><h2 id="安装umami">安装Umami</h2>
<p>安装umami是一个简单的过程。但不当的配置可能使其变得非常复杂。请确保接下来执行的所有命令都在<em>干净的</em>目录中。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">#安装umami并使用yarn安装</span>
</span></span><span style="display:flex;"><span>git clone https://github.com/umami-software/umami.git
</span></span><span style="display:flex;"><span>cd umami
</span></span><span style="display:flex;"><span>yarn install
</span></span></code></pre></div><p>接下来需要对umami的环境进行一些配置。使用<code>vim .env</code>打开环境变量文件，开始配置</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-env" data-lang="env"><span style="display:flex;"><span>DATABASE_URL<span style="color:#f92672">=(</span>connection url<span style="color:#f92672">)</span>
</span></span></code></pre></div><p>这里的connection url代表的是postgresql的连接地址。它应该是：<code>postgresql://postgresql:你设置的密码@127.0.0.1:5432/数据库名称</code></p>
<p>在完成这些步骤后可以进行最后一部的安装：构建和运行。</p>
<h2 id="构建运行和后续配置">构建、运行和后续配置</h2>
<p>使用<code>yarn build</code>完成最终配置（依CPU性能而决定耗时，一般5分钟）。并使用<code>yarn start</code>开始运行。请访问<code>http://服务器IP:3000</code>查看页面。</p>
<p>为了提升安全性，可以使用caddy或其他web server进行反代。并且，可以更改默认的密码。默认帐号<code>admin</code>，密码<code>umami</code>.</p>

</article>

            </div>
        </main>
    </body>
</html>
